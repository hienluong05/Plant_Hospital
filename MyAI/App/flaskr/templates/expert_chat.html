<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat with Experts - Plant Hospital</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
      body {
        background: linear-gradient(120deg, #e3f2fd 0%, #e8f5e9 100%);
        font-family: "Segoe UI", Arial, sans-serif;
        margin: 0;
        min-height: 100vh;
        color: #333;
      }
      .chat-main-container {
        max-width: 800px;
        margin: 44px auto;
        box-shadow: 0 7px 38px #388e3c22;
        border-radius: 23px;
        background: #fff;
        overflow: hidden;
      }
      .chat-header {
        background: linear-gradient(90deg, #388e3c 80%, #ff9800 100%);
        color: #fff;
        padding: 28px 32px 17px 32px;
        display: flex;
        align-items: center;
        gap: 18px;
      }
      .chat-header .icon {
        font-size: 2.2rem;
        background: #fff;
        color: #388e3c;
        border-radius: 50%;
        padding: 13px;
        box-shadow: 0 2px 10px #388e3c17;
      }
      .chat-header .title {
        font-size: 1.35rem;
        font-weight: 700;
        letter-spacing: 0.2px;
      }
      .chat-header .session-info {
        font-size: 1.01rem;
        font-weight: 500;
        opacity: 0.93;
        margin-left: auto;
      }
      .chat-box {
        background: #f8fff8;
        padding: 34px 20px 24px 20px;
        min-height: 460px;
        max-height: 600px;
        overflow-y: auto;
        border-bottom: 1.5px solid #e3f2fd;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .msg-row {
        display: flex;
        align-items: flex-end;
        gap: 11px;
      }
      .msg-row.user {
        flex-direction: row-reverse;
      }
      .msg-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: #e3f2fd;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.26rem;
        box-shadow: 0 1px 7px #388e3c18;
        flex-shrink: 0;
      }
      .msg-row.user .msg-avatar {
        background: #ffe0b2;
        color: #ff9800;
      }
      .msg-row.expert .msg-avatar {
        background: #e8f5e9;
        color: #388e3c;
      }
      .msg-bubble {
        max-width: 78vw;
        min-width: 62px;
        padding: 15px 22px 11px 22px;
        border-radius: 20px;
        font-size: 1.11rem;
        line-height: 1.48;
        box-shadow: 0 2px 13px #388e3c11;
        position: relative;
        background: #e3f2fd;
        color: #1976d2;
        word-break: break-word;
        display: flex;
        flex-direction: column;
      }
      .msg-row.user .msg-bubble {
        background: #ffe0b2;
        color: #ff9800;
        border-bottom-left-radius: 12px;
        border-bottom-right-radius: 20px;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        align-items: flex-end;
      }
      .msg-row.expert .msg-bubble {
        background: #e8f5e9;
        color: #388e3c;
        border-bottom-right-radius: 12px;
        border-bottom-left-radius: 20px;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        align-items: flex-start;
      }
      .msg-header {
        font-weight: 600;
        margin-bottom: 5px;
        font-size: 1.05rem;
        opacity: 0.97;
      }
      .msg-meta {
        font-size: 0.93rem;
        color: #aaa;
        margin-top: 6px;
        text-align: right;
      }
      .msg-row.user .msg-meta {
        text-align: left;
      }
      .msg-image {
        margin-top: 8px;
        max-width: 230px;
        max-height: 170px;
        border-radius: 9px;
        box-shadow: 0 2px 8px #388e3c20;
      }
      .chat-form-wrapper {
        padding: 18px 26px 28px 26px;
        background: #fff;
        border-radius: 0 0 23px 23px;
        display: flex;
        align-items: flex-end;
        gap: 12px;
        border-top: 1.5px solid #e3f2fd;
      }
      .chat-send-form {
        flex: 1;
        display: flex;
        gap: 13px;
      }
      .chat-send-form textarea {
        flex: 1;
        border-radius: 13px;
        border: 1.5px solid #cfd8dc;
        font-size: 1.13rem;
        background: #f8fff8;
        padding: 13px;
        resize: none;
        min-height: 42px;
        max-height: 125px;
        transition: border 0.18s;
      }
      .chat-send-form textarea:focus {
        border: 1.5px solid #388e3c;
        background: #fff;
      }
      .chat-send-form button {
        background: linear-gradient(90deg, #388e3c 80%, #ff9800 100%);
        color: #fff;
        border: none;
        border-radius: 12px;
        padding: 12px 32px;
        font-weight: 600;
        font-size: 1.13rem;
        cursor: pointer;
        transition: background 0.18s;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .chat-send-form button:hover {
        background: linear-gradient(90deg, #1976d2 80%, #fb8c00 100%);
      }
      .btn-img {
        background: #e3f2fd;
        border: none;
        border-radius: 10px;
        padding: 9px 13px;
        color: #1976d2;
        font-size: 1.25rem;
        cursor: pointer;
        transition: background 0.14s, color 0.15s;
        margin-left: 6px;
        margin-right: 3px;
      }
      .btn-img:hover {
        background: #ff9800;
        color: #fff;
      }
      #imagePreview {
        margin-left: 12px;
        margin-top: 3px;
        display: inline-block;
      }
      #imagePreview img {
        max-width: 100px;
        border-radius: 7px;
        margin-top: 3px;
        box-shadow: 0 2px 8px #388e3c20;
      }
      @media (max-width: 900px) {
        .chat-main-container {
          margin: 0;
          border-radius: 0;
        }
        .chat-header {
          padding: 14px 9vw 8px 9vw;
          font-size: 1.07rem;
          gap: 9px;
        }
        .chat-box {
          padding: 12px 4vw 6px 4vw;
          min-height: 240px;
          max-height: 260px;
        }
        .chat-form-wrapper {
          padding: 10px 4vw 13px 4vw;
        }
        .chat-send-form button,
        .btn-img {
          padding: 8px 11px;
          font-size: 0.98rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="chat-main-container">
      <div class="chat-header">
        <span class="icon"><i class="fas fa-user"></i></span>
        <span class="title">Chat with Expert</span>
        <span class="session-info" id="sessionInfo"></span>
      </div>
      <div class="chat-box" id="chat-history"></div>
      <div class="chat-form-wrapper">
        <form
          class="chat-send-form"
          onsubmit="event.preventDefault(); sendMessage();"
        >
          <textarea
            id="messageInput"
            placeholder="Type your message..."
            required
            rows="2"
          ></textarea>
          <button type="submit"><i class="fas fa-paper-plane"></i> Send</button>
          <button
            type="button"
            class="btn-img"
            onclick="document.getElementById('imageInput').click()"
            title="Send Image"
          >
            <i class="fas fa-image"></i>
          </button>
          <input
            type="file"
            id="imageInput"
            accept="image/*"
            style="display: none"
            onchange="previewImage(this)"
          />
        </form>
        <div id="imagePreview"></div>
      </div>
    </div>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script>
      // Khởi tạo sessionId nếu cần, hoặc nhận từ biến python render
      const sessionId = window.sessionId || "{{ session_id or '' }}";

      const socket = io();
      let selectedImage = null;

      socket.on("connect", function () {
        socket.emit("join_chat", { session_id: sessionId });
        document.getElementById("sessionInfo").innerHTML = sessionId
          ? "<i class='fas fa-hashtag'></i> " + sessionId
          : "";
      });

      socket.on("chat_history", function (messages) {
        const container = document.getElementById("chat-history");
        container.innerHTML = "";
        messages.forEach(displayMessage);
        scrollToBottom();
      });

      socket.on("receive_message", function (data) {
        displayMessage(data);
        scrollToBottom();
      });

      function displayMessage(data) {
        const container = document.getElementById("chat-history");
        const msgRow = document.createElement("div");
        msgRow.className =
          "msg-row " + (data.sender_type === "user" ? "user" : "expert");

        const avatar = document.createElement("div");
        avatar.className = "msg-avatar";
        avatar.innerHTML =
          data.sender_type === "user"
            ? '<i class="fas fa-user"></i>'
            : '<i class="fas fa-user-md"></i>';

        const bubble = document.createElement("div");
        bubble.className = "msg-bubble";
        bubble.innerHTML =
          `<div class="msg-header">${
            data.sender_name ||
            (data.sender_type === "expert" ? "Expert" : "You")
          }</div>` +
          (data.content ? `<div>${data.content}</div>` : "") +
          (data.image_path
            ? `<img src="/static/${data.image_path}" class="msg-image" alt="Shared image">`
            : "") +
          `<div class="msg-meta">${data.timestamp || ""}</div>`;

        msgRow.appendChild(avatar);
        msgRow.appendChild(bubble);
        container.appendChild(msgRow);
      }

      function sendMessage() {
        const input = document.getElementById("messageInput");
        const message = input.value.trim();

        if (selectedImage) {
          // Gửi ảnh và kèm message (nếu có)
          socket.emit("send_image", {
            image: selectedImage,
            message: message,
            session_id: sessionId,
          });
          input.value = "";
          document.getElementById("imageInput").value = "";
          document.getElementById("imagePreview").innerHTML = "";
          selectedImage = null;
        } else if (message) {
          socket.emit("send_message", {
            message: message,
            session_id: sessionId,
          });
          input.value = "";
        }
      }

      function previewImage(input) {
        const preview = document.getElementById("imagePreview");
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            selectedImage = e.target.result;
            preview.innerHTML = `
              <img src="${e.target.result}" alt="Preview">
              <p class="text-muted" style="font-size:0.97em">Ảnh đã chọn - nhấn "Send" để gửi</p>
            `;
          };
          reader.readAsDataURL(input.files[0]);
        }
      }

      document
        .getElementById("messageInput")
        .addEventListener("keydown", function (event) {
          if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
          }
        });

      function scrollToBottom() {
        const container = document.getElementById("chat-history");
        container.scrollTop = container.scrollHeight;
      }
    </script>
  </body>
</html>
