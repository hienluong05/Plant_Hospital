<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Expert Live Chat - Plant Hospital</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        background: linear-gradient(120deg, #e3f2fd 0%, #e8f5e9 100%);
        font-family: "Segoe UI", Arial, sans-serif;
        margin: 0;
        min-height: 100vh;
        color: #333;
      }
      .chat-main-container {
        max-width: 650px;
        margin: 40px auto;
        box-shadow: 0 6px 32px #388e3c22;
        border-radius: 20px;
        background: #fff;
        overflow: hidden;
      }
      .chat-header {
        background: linear-gradient(
          90deg,
          #257c36 70%,
          #388e3c 90%,
          #1976d2 100%
        );
        color: #fff;
        padding: 26px 32px 17px 32px;
        display: flex;
        align-items: center;
        gap: 18px;
      }
      .chat-header .icon {
        font-size: 2.2rem;
        background: #fff;
        color: #257c36;
        border-radius: 50%;
        padding: 12px;
        box-shadow: 0 2px 10px #4caf5017;
      }
      .chat-header .title {
        font-size: 1.3rem;
        font-weight: 700;
        letter-spacing: 0.2px;
      }
      .chat-header .session-info {
        font-size: 1rem;
        font-weight: 500;
        opacity: 0.93;
        margin-left: auto;
      }
      .chat-box {
        background: #f8fff8;
        padding: 30px 16px 20px 16px;
        min-height: 340px;
        max-height: 420px;
        overflow-y: auto;
        border-bottom: 1.5px solid #e3f2fd;
        display: flex;
        flex-direction: column;
        gap: 13px;
      }
      .msg-row {
        display: flex;
        align-items: flex-end;
        gap: 9px;
      }
      .msg-row.expert {
        flex-direction: row-reverse;
      }
      .msg-avatar {
        width: 38px;
        height: 38px;
        border-radius: 50%;
        background: #e8f5e9;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        box-shadow: 0 1px 7px #388e3c18;
      }
      .msg-row.user .msg-avatar {
        background: #e3f2fd;
        color: #1976d2;
      }
      .msg-row.expert .msg-avatar {
        background: #ffe0b2;
        color: #ff9800;
      }
      .msg-bubble {
        max-width: 72vw;
        min-width: 62px;
        padding: 13px 18px 10px 18px;
        border-radius: 18px;
        font-size: 1.07rem;
        line-height: 1.48;
        box-shadow: 0 2px 10px #388e3c10;
        position: relative;
        background: #e3f2fd;
        color: #1976d2;
        word-break: break-word;
      }
      .msg-row.expert .msg-bubble {
        background: #e8f5e9;
        color: #388e3c;
        border-bottom-right-radius: 8px;
        border-bottom-left-radius: 18px;
        border-top-left-radius: 18px;
        border-top-right-radius: 18px;
      }
      .msg-row.user .msg-bubble {
        background: #e3f2fd;
        color: #1976d2;
        border-bottom-left-radius: 8px;
        border-bottom-right-radius: 18px;
        border-top-left-radius: 18px;
        border-top-right-radius: 18px;
      }
      .msg-header {
        font-weight: 600;
        margin-bottom: 5px;
        font-size: 1.05rem;
        opacity: 0.97;
      }
      .msg-meta {
        font-size: 0.93rem;
        color: #aaa;
        margin-top: 5px;
        text-align: right;
      }
      .msg-row.expert .msg-meta {
        text-align: left;
      }
      .chat-form-wrapper {
        padding: 18px 24px 26px 24px;
        background: #fff;
        border-radius: 0 0 20px 20px;
        display: flex;
        align-items: flex-end;
        gap: 12px;
        border-top: 1.5px solid #e3f2fd;
      }
      .chat-send-form {
        flex: 1;
        display: flex;
        gap: 13px;
      }
      .chat-send-form textarea {
        flex: 1;
        border-radius: 12px;
        border: 1.5px solid #cfd8dc;
        font-size: 1.07rem;
        background: #f8fff8;
        padding: 12px;
        resize: none;
        min-height: 38px;
        max-height: 120px;
        transition: border 0.18s;
      }
      .chat-send-form textarea:focus {
        border: 1.5px solid #257c36;
        background: #fff;
      }
      .chat-send-form button {
        background: linear-gradient(
          90deg,
          #257c36 70%,
          #388e3c 90%,
          #1976d2 100%
        );
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 11px 28px;
        font-weight: 600;
        font-size: 1.11rem;
        cursor: pointer;
        transition: background 0.18s;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .chat-send-form button:hover {
        background: linear-gradient(90deg, #1976d2 80%, #388e3c 100%);
      }
      .btn-back {
        background: #888;
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 10px 22px;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        margin-left: 13px;
        text-decoration: none;
        transition: background 0.17s;
      }
      .btn-back:hover {
        background: #1976d2;
      }
      @media (max-width: 700px) {
        .chat-main-container {
          margin: 0;
          border-radius: 0;
        }
        .chat-header {
          padding: 16px 12px 11px 12px;
          font-size: 1.07rem;
          gap: 9px;
        }
        .chat-box {
          padding: 12px 4vw 6px 4vw;
          min-height: 260px;
          max-height: 270px;
        }
        .chat-form-wrapper {
          padding: 10px 4vw 13px 4vw;
        }
        .chat-send-form button,
        .btn-back {
          padding: 8px 12px;
          font-size: 0.98rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="chat-main-container">
      <div class="chat-header">
        <span class="icon"><i class="fas fa-user-md"></i></span>
        <span class="title">Expert Chat: {{ session.username }}</span>
        <span class="session-info">
          <i class="fas fa-hashtag"></i> {{ session.id }}
        </span>
      </div>
      <div class="chat-box" id="chat-history"></div>
      <div class="chat-form-wrapper">
        <form
          class="chat-send-form"
          onsubmit="event.preventDefault(); sendMessage();"
        >
          <textarea
            id="messageInput"
            placeholder="Type your reply..."
            required
            rows="2"
          ></textarea>
          <button type="submit"><i class="fas fa-paper-plane"></i> Send</button>
        </form>
        <a href="{{ url_for('expert.chat_sessions') }}" class="btn-back"
          >Back</a
        >
      </div>
    </div>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script>
      // Setup socket
      const sessionId = "{{ session.id }}";
      const expertName =
        "{{ session['expert_name'] if session['expert_name'] else session['username'] if session['username'] else 'Expert' }}";

      const socket = io();
      socket.on("connect", function () {
        socket.emit("join_chat", { session_id: sessionId, as_expert: true });
      });

      socket.on("chat_history", function (messages) {
        const container = document.getElementById("chat-history");
        container.innerHTML = "";
        messages.forEach(displayMessage);
        scrollToBottom();
      });

      socket.on("receive_message", function (data) {
        displayMessage(data);
        scrollToBottom();
      });

      function displayMessage(data) {
        const container = document.getElementById("chat-history");
        const msgRow = document.createElement("div");
        msgRow.className =
          "msg-row " + (data.sender_type === "expert" ? "expert" : "user");

        const avatar = document.createElement("div");
        avatar.className = "msg-avatar";
        avatar.innerHTML =
          data.sender_type === "expert"
            ? '<i class="fas fa-user-md"></i>'
            : '<i class="fas fa-user"></i>';

        const bubble = document.createElement("div");
        bubble.className = "msg-bubble";
        bubble.innerHTML =
          `<div class="msg-header">${
            data.sender_name ||
            (data.sender_type === "expert" ? "Expert" : "User")
          }</div>` +
          `<div>${data.content || ""}</div>` +
          `<div class="msg-meta">${data.timestamp || ""}</div>`;

        msgRow.appendChild(avatar);
        msgRow.appendChild(bubble);
        container.appendChild(msgRow);
      }

      function sendMessage() {
        const input = document.getElementById("messageInput");
        const message = input.value.trim();
        if (!message) return;
        socket.emit("send_message", {
          message: message,
          session_id: sessionId,
        });
        input.value = "";
      }
      function scrollToBottom() {
        const container = document.getElementById("chat-history");
        container.scrollTop = container.scrollHeight;
      }

      // Allow Enter to send
      document
        .getElementById("messageInput")
        .addEventListener("keydown", function (event) {
          if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
          }
        });
    </script>
  </body>
</html>
