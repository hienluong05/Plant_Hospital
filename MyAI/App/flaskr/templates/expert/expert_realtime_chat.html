<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Expert Live Chat - Plant Hospital</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: #f8f9fa;
        font-family: "Segoe UI", Arial, sans-serif;
      }
      .chat-container {
        height: 500px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 15px;
        background-color: #f8f9fa;
      }
      .message {
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 10px;
        max-width: 70%;
      }
      .expert-message {
        background-color: #388e3c;
        color: white;
        margin-left: auto;
      }
      .user-message {
        background-color: #1976d2;
        color: white;
      }
      .other-message {
        background-color: #e9ecef;
        color: #333;
      }
      .timestamp {
        font-size: 0.8em;
        opacity: 0.7;
        margin-top: 5px;
      }
      .msg-header {
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="container mt-4">
      <div class="row">
        <div class="col-md-8 mx-auto">
          <div class="card">
            <div class="card-header bg-success text-white">
              <h4>
                <i class="fas fa-comments"></i> Expert Chat with User:
                <span id="userName">{{ session.username }}</span>
              </h4>
              <small
                >Session ID: <span id="sessionId">{{ session.id }}</span></small
              >
            </div>
            <div class="card-body">
              <div id="chatContainer" class="chat-container mb-3"></div>
              <div class="input-group mb-3">
                <input
                  type="text"
                  id="messageInput"
                  class="form-control"
                  placeholder="Type your message..."
                  onkeypress="handleKeyPress(event)"
                />
                <button class="btn btn-success" onclick="sendMessage()">
                  <i class="fas fa-paper-plane"></i> Send
                </button>
              </div>
            </div>
          </div>
          <div class="text-center mt-3">
            <a
              href="{{ url_for('expert.chat_sessions') }}"
              class="btn btn-secondary"
              >Back to Sessions</a
            >
          </div>
        </div>
      </div>
    </div>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <script>
      const sessionId = "{{ session.id }}";
      const expertName =
        "{{ session['expert_name'] if session['expert_name'] else session['username'] if session['username'] else 'Expert' }}";

      const socket = io();
      socket.on("connect", function () {
        socket.emit("join_chat", { session_id: sessionId, as_expert: true });
      });

      socket.on("chat_history", function (messages) {
        const container = document.getElementById("chatContainer");
        container.innerHTML = "";
        messages.forEach(displayMessage);
        scrollToBottom();
      });

      socket.on("receive_message", function (data) {
        displayMessage(data);
        scrollToBottom();
      });

      function displayMessage(data) {
        const container = document.getElementById("chatContainer");
        const messageDiv = document.createElement("div");
        let messageClass = "other-message";
        if (data.sender_type === "expert") messageClass = "expert-message";
        else if (data.sender_type === "user") messageClass = "user-message";
        messageDiv.className = `message ${messageClass}`;
        let html = `<div class="msg-header">${
          data.sender_name || "Unknown"
        }:</div>`;
        if (data.content) html += `<div>${data.content}</div>`;
        html += `<div class="timestamp">${data.timestamp || ""}</div>`;
        messageDiv.innerHTML = html;
        container.appendChild(messageDiv);
      }

      function sendMessage() {
        const input = document.getElementById("messageInput");
        const message = input.value.trim();
        if (!message) return;
        socket.emit("send_message", {
          message: message,
          session_id: sessionId,
        });
        input.value = "";
      }
      function handleKeyPress(event) {
        if (event.key === "Enter") sendMessage();
      }
      function scrollToBottom() {
        const container = document.getElementById("chatContainer");
        container.scrollTop = container.scrollHeight;
      }
    </script>
  </body>
</html>
